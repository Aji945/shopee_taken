<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éš†è³€æª¢è²¨ç³»çµ±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            margin: 0;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: #333;
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .sync-status {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        .product-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .product-group {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        .product-group-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px 25px;
            text-align: center;
            font-size: 33px;
            font-weight: 700;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .product-header {
            background: linear-gradient(135deg, #2d3748, #4a5568);
            color: white;
            padding: 25px;
            text-align: center;
            position: relative;
        }

        .product-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), transparent);
            pointer-events: none;
        }

        .main-sku {
            font-size: 22px;
            font-weight: 800;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .product-name {
            font-size: 20px;
            font-weight: 700;
            line-height: 1.4;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        .variants-container {
            padding: 20px;
        }

        .variant-card {
            background: linear-gradient(135deg, #f8f9ff, #ffffff);
            border-radius: 16px;
            padding: 22px;
            margin-bottom: 18px;
            border: 2px solid rgba(102, 126, 234, 0.1);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .variant-card:last-child {
            margin-bottom: 0;
        }

        .variant-card.checked {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-color: #28a745;
            transform: scale(0.98);
            box-shadow: 0 6px 25px rgba(40, 167, 69, 0.2);
        }

        .variant-card.shortage {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-color: #ffc107;
            box-shadow: 0 6px 25px rgba(255, 193, 7, 0.2);
        }

        .variant-card.restock {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            border-color: #dc3545;
            box-shadow: 0 6px 25px rgba(220, 53, 69, 0.2);
        }

        .variant-card.position-error {
            background: linear-gradient(135deg, #e9d8fd, #d6bcfa);
            border-color: #805ad5;
            box-shadow: 0 6px 25px rgba(128, 90, 213, 0.2);
        }

        .variant-header {
            margin-bottom: 20px;
        }

        .location-primary {
            font-size: 28px;
            font-weight: 800;
            color: #2d3748;
            margin-bottom: 12px;
            text-align: center;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .spec-name {
            font-size: 18px;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 10px;
            text-align: center;
        }

        .option-sku-quantity {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(102, 126, 234, 0.1);
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 15px;
            gap: 2px;
        }
        .option-sku {
            font-size: 22px;
            color: #203cb9;
            font-weight: 600;
            margin-bottom: 2px;
        }
        .quantity-display {
            font-size: 33px;
            font-weight: 800;
            color: #2d3748;
        }

        .variant-details {
            margin-bottom: 15px;
        }

        .detail-row {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            font-size: 24px;
            padding: 8px 0;
        }

        .detail-icon {
            font-size: 18px;
            margin-right: 12px;
            width: 24px;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        .detail-text {
            color: #4a5568;
            font-weight: 600;
        }

        .status-display {
            text-align: center;
            margin-bottom: 18px;
            font-weight: 700;
            font-size: 18px;
            padding: 12px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-top: 5px;
        }

        .action-btn {
            padding: 9px 4px;
            border: none;
            border-radius: 12px;
            font-size: 24px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-checked {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .btn-shortage {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
        }

        .btn-restock {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            color: white;
        }

        .btn-position-error {
            background: linear-gradient(135deg, #9f7aea, #805ad5);
            color: white;
        }

        .btn-note {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
        }

        .btn-restore {
            background: linear-gradient(135deg, #718096, #4a5568);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        .action-btn.active {
            opacity: 1;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
            transform: translateY(-1px);
        }

        .action-btn:not(.active) {
            opacity: 0.7;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1001;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 25px;
            text-align: center;
            color: #2d3748;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .number-input {
            width: 100%;
            padding: 18px;
            font-size: 28px;
            text-align: center;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.8);
            font-weight: 600;
            color: #2d3748;
        }

        .number-pad {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 25px;
        }

        .number-btn {
            padding: 14px;
            font-size: 22px;
            font-weight: 700;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.9));
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: #4a5568;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .number-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
            border-color: rgba(102, 126, 234, 0.4);
        }

        .number-btn:active {
            transform: scale(0.95);
        }

        .unit-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .unit-btn {
            padding: 12px 16px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: #4a5568;
        }

        .unit-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .unit-btn:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .modal-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .modal-btn {
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .btn-confirm {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .btn-cancel {
            background: linear-gradient(135deg, #718096, #4a5568);
            color: white;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .modal-btn:active {
            transform: scale(0.95);
        }

        .note-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            box-sizing: border-box;
        }

        .note-input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            
        }

        .status-indicator {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            margin-right: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .status-checked { background: linear-gradient(135deg, #48bb78, #38a169); }
        .status-shortage { background: linear-gradient(135deg, #ed8936, #dd6b20); }
        .status-restock { background: linear-gradient(135deg, #f56565, #e53e3e); }
        .status-pending { background: linear-gradient(135deg, #e2e8f0, #cbd5e0); }

        .success-banner {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            text-align: center;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .sync-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 25px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1001;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .sync-indicator.uploading {
            background: rgba(255, 193, 7, 0.9);
            color: #333;
        }

        .sync-indicator.success {
            background: rgba(72, 187, 120, 0.9);
            color: white;
        }

        .sync-indicator.error {
            background: rgba(245, 101, 101, 0.9);
            color: white;
        }

        .sync-indicator.hidden {
            opacity: 0;
            transform: translateY(-10px);
        }

        /* æœå°‹å’Œç¯©é¸å€åŸŸ */
        .search-filter-container {
            position: sticky;
            top: 10px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            margin-bottom: 20px;
            padding: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .search-filter-row {
            display: grid;
            grid-template-columns: 1fr auto auto auto auto;
            gap: 10px;
            align-items: center;
        }

        .search-container {
            position: relative;
        }

        .search-box {
            width: 100%;
            padding: 12px 40px 12px 15px;
            font-size: 14px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .search-clear-btn {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #666;
            transition: all 0.3s ease;
            width: 26px;
            height: 26px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-clear-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .search-clear-btn.hidden {
            display: none;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.2);
        }

        .filter-buttons {
            display: contents;
        }

        .filter-btn {
            padding: 8px 2px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            color: #4a5568;
            white-space: nowrap;
            min-width: 40px;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .filter-btn:hover:not(.active) {
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .filter-btn:active {
            transform: scale(0.95);
        }

        .filter-btn {
            position: relative;
        }

        .count-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #f56565;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(245, 101, 101, 0.4);
        }

        /* å³ä¸‹è§’æµ®å‹•æŒ‰éµå€åŸŸ */
        .floating-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 200;
        }

        .floating-btn {
            width: 60px;
            height: 60px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            position: relative;
        }

        .floating-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.4);
        }

        .floating-btn:active {
            transform: scale(0.95);
        }

        .floating-btn.pending-filter {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
        }

        .floating-btn.pending-filter.active {
            background: linear-gradient(135deg, #f56565, #e53e3e);
            box-shadow: 0 8px 25px rgba(245, 101, 101, 0.4);
        }

        .floating-btn.nav-up {
            background: linear-gradient(135deg, #38a169, #2f855a);
        }

        .floating-btn.nav-down {
            background: linear-gradient(135deg, #38a169, #2f855a);
        }
    </style>
</head>
<body>
    <!-- åŒæ­¥ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
    <div id="syncIndicator" class="sync-indicator hidden"></div>

    <!-- æœå°‹å’Œç¯©é¸å€åŸŸ -->
    <div class="search-filter-container">
        <div class="search-filter-row">
            <div class="search-container">
                <input type="text" class="search-box" id="searchBox" placeholder="ğŸ” æœå°‹..." oninput="filterProducts()">
                <button class="search-clear-btn hidden" id="searchClearBtn" onclick="clearSearch()">âœ•</button>
            </div>
            <div class="filter-buttons">
                <button class="filter-btn active" id="filterAll" onclick="setFilter('all')">å…¨éƒ¨</button>
                <button class="filter-btn" id="filterShortage" onclick="setFilter('shortage')">ç¼ºé‡</button>
                <button class="filter-btn" id="filterRestock" onclick="setFilter('restock')">è¦è£œè²¨</button>
                <button class="filter-btn" id="filterPositionError" onclick="setFilter('position-error')">å€‰ä½éŒ¯</button>
                <button class="filter-btn" id="filterPending" onclick="setFilter('pending')">
                    æœªè™•ç†
                    <span class="count-badge" id="pendingCountBadge" style="display: none;">0</span>
                </button>
            </div>
        </div>
    </div>

    <div id="loadingDiv" class="loading">
        æ­£åœ¨åŠ è¼‰å•†å“è³‡æ–™...
    </div>

    <div id="productList" class="product-list" style="display: none;">
        <!-- å•†å“å¡ç‰‡å°‡å‹•æ…‹ç”Ÿæˆ -->
    </div>

    <!-- å³ä¸‹è§’æµ®å‹•æ§åˆ¶æŒ‰éµ -->
    <div class="floating-controls">
        <button class="floating-btn nav-up" onclick="navigateToPending('up')" title="ä¸Šä¸€å€‹æœªè™•ç†é …ç›®">
            â†‘
        </button>
        <button class="floating-btn nav-down" onclick="navigateToPending('down')" title="ä¸‹ä¸€å€‹æœªè™•ç†é …ç›®">
            â†“
        </button>
    </div>

    <!-- æ•¸é‡è¼¸å…¥æ¨¡æ…‹æ¡† -->
    <div id="quantityModal" class="modal">
        <div class="modal-content">
            <div class="modal-title" id="modalTitle">è¼¸å…¥æ•¸é‡</div>
            <input type="text" id="quantityInput" class="number-input" readonly>
            <div class="number-pad">
                <button class="number-btn" onclick="addNumber('1')">1</button>
                <button class="number-btn" onclick="addNumber('2')">2</button>
                <button class="number-btn" onclick="addNumber('3')">3</button>
                <button class="number-btn" onclick="addNumber('4')">4</button>
                <button class="number-btn" onclick="addNumber('5')">5</button>
                <button class="number-btn" onclick="addNumber('6')">6</button>
                <button class="number-btn" onclick="addNumber('7')">7</button>
                <button class="number-btn" onclick="addNumber('8')">8</button>
                <button class="number-btn" onclick="addNumber('9')">9</button>
                <button class="number-btn" onclick="clearNumber()">æ¸…é™¤</button>
                <button class="number-btn" onclick="addNumber('0')">0</button>
                <button class="number-btn" onclick="deleteNumber()">åˆªé™¤</button>
            </div>
            <div class="unit-buttons">
                <button class="unit-btn active" id="unitPcs" onclick="selectUnit('å…¥')">ğŸ“¦ å…¥</button>
                <button class="unit-btn" id="unitBox" onclick="selectUnit('ç®±')">ğŸ“‹ ç®±</button>
            </div>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="modal-btn btn-confirm" onclick="confirmQuantity()">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <!-- å‚™è¨»è¼¸å…¥ Modal -->
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <textarea id="noteInput" class="note-input" placeholder="è«‹è¼¸å…¥å‚™è¨»..." rows="4"></textarea>
            <div class="modal-actions">
                <button class="modal-btn btn-cancel" onclick="closeNoteModal()">å–æ¶ˆ</button>
                <button class="modal-btn btn-confirm" onclick="confirmNote()">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€è®Šé‡
        const SHEET_ID = '1xja90NLxCTbQgxUSdx4nI0-BJXMLr0DHhu7Xln612vI';
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwFSPXkgQRDm4nUk4ctqrzKBjqeasJ0uSRpBYDNoqX4OlI_PLtiznjomf6viXkrPF4w/exec';
        
        let productsData = [];
        let currentRowIndex = null;
        let currentActionType = null;
        let callbackCounter = 0;
        let syncIndicatorTimeout = null;
        let localUpdates = new Map(); // è¿½è¹¤æœ¬åœ°æ›´æ–°
        let lastUpdateTime = new Map(); // è¿½è¹¤æœ€å¾Œæ›´æ–°æ™‚é–“
        let isUpdating = false; // é˜²æ­¢åŒæ™‚æ›´æ–°
        let currentFilter = 'all'; // ç•¶å‰ç¯©é¸ç‹€æ…‹
        let searchQuery = ''; // ç•¶å‰æœå°‹æŸ¥è©¢
        let selectedUnit = 'å…¥'; // ç•¶å‰é¸æ“‡çš„å–®ä½
        
        // å·¥å…·å‡½æ•¸
        function getProductKey(productName, specName) {
            return `${productName}|||${specName}`;
        }

        function markLocalUpdate(productName, specName, updateType) {
            const key = getProductKey(productName, specName);
            const now = Date.now();
            localUpdates.set(key, { type: updateType, timestamp: now });
            lastUpdateTime.set(key, now);
        }

        function isRecentLocalUpdate(productName, specName, timeWindow = 10000) {
            const key = getProductKey(productName, specName);
            const updateTime = lastUpdateTime.get(key);
            return updateTime && (Date.now() - updateTime) < timeWindow;
        }



        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            setInterval(refreshProducts, 30000); // æ¯1.5ç§’è‡ªå‹•æ›´æ–°ï¼Œæå‡åŒæ­¥é€Ÿåº¦
        });

        // JSONPè«‹æ±‚å‡½æ•¸
        function jsonpRequest(url, params = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = `jsonp_callback_${++callbackCounter}`;
                const script = document.createElement('script');
                
                // æ·»åŠ è¶…æ™‚è™•ç†
                const timeout = setTimeout(() => {
                    reject(new Error('JSONP request timeout'));
                    if (document.head.contains(script)) {
                        document.head.removeChild(script);
                    }
                    delete window[callbackName];
                }, 10000); // 10ç§’è¶…æ™‚
                
                // è¨­ç½®å…¨å±€å›èª¿å‡½æ•¸
                window[callbackName] = function(data) {
                    clearTimeout(timeout);
                    resolve(data);
                    if (document.head.contains(script)) {
                        document.head.removeChild(script);
                    }
                    delete window[callbackName];
                };
                
                // æ§‹å»ºURL
                const urlParams = new URLSearchParams({
                    ...params,
                    callback: callbackName
                });
                
                script.src = `${url}?${urlParams.toString()}`;
                
                script.onerror = () => {
                    clearTimeout(timeout);
                    reject(new Error('JSONP request failed'));
                    if (document.head.contains(script)) {
                        document.head.removeChild(script);
                    }
                    delete window[callbackName];
                };
                
                document.head.appendChild(script);
            });
        }

        // åŠ è¼‰å•†å“è³‡æ–™
        async function loadProducts() {
            try {
                updateSyncStatus('loading', 'æ­£åœ¨åŒæ­¥è³‡æ–™...');
                console.log('é–‹å§‹è¼‰å…¥å•†å“è³‡æ–™...'); // èª¿è©¦ä¿¡æ¯
                
                const result = await jsonpRequest(GAS_WEB_APP_URL, {
                    action: 'read',
                    sheetId: SHEET_ID
                });
                
                console.log('è¼‰å…¥çµæœ:', result); // èª¿è©¦ä¿¡æ¯
                console.log('ç¬¬ä¸€è¡Œè³‡æ–™çµæ§‹:', result.data[0]); // èª¿è©¦ä¿¡æ¯
                console.log('ç¬¬äºŒè¡Œè³‡æ–™çµæ§‹:', result.data[1]); // èª¿è©¦ä¿¡æ¯
                
                if (result && result.success && result.data && result.data.length > 1) {
                    productsData = result.data.slice(1); // è·³éæ¨™é¡Œè¡Œ
                    console.log('æˆåŠŸè¼‰å…¥ç”¢å“æ•¸é‡:', productsData.length); // èª¿è©¦ä¿¡æ¯
                    
                    renderProducts();
                    updateSyncStatus('success', 'è³‡æ–™åŒæ­¥å®Œæˆ');
                } else {
                    console.error('è¼‰å…¥å¤±æ•—:', result); // èª¿è©¦ä¿¡æ¯
                    throw new Error(result?.error || 'ç„¡æ³•å–å¾—è³‡æ–™æˆ–è³‡æ–™æ ¼å¼éŒ¯èª¤');
                }
            } catch (error) {
                console.error('è¼‰å…¥å•†å“è³‡æ–™éŒ¯èª¤:', error); // èª¿è©¦ä¿¡æ¯
                
                // é¡¯ç¤ºè©³ç´°éŒ¯èª¤ä¿¡æ¯çµ¦ç”¨æˆ¶
                const loadingDiv = document.getElementById('loadingDiv');
                loadingDiv.innerHTML = `
                    <div style="color: #f56565; text-align: center;">
                        <h3>è¼‰å…¥å¤±æ•—</h3>
                        <p>éŒ¯èª¤ä¿¡æ¯ï¼š${error.message}</p>
                        <button onclick="loadProducts()" style="
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            cursor: pointer;
                            margin-top: 16px;
                        ">é‡æ–°è¼‰å…¥</button>
                    </div>
                `;
                
                updateSyncStatus('error', `è¼‰å…¥å¤±æ•—: ${error.message}`);
            }
        }

        // ä¿æŒåŸå§‹é †åºï¼Œæ•´åˆç·Šé„°çš„ç›¸åŒå•†å“åç¨±+ç›¸åŒå„²ä½
        function processProductsData(data) {
            const result = [];
            const processed = new Set();
            
            data.forEach((row, originalIndex) => {
                if (processed.has(originalIndex)) return;
                
                const productName = row[1] || '';
                const location = row[4] || '';
                const key = `${productName}|||${location}`;
                
                // æ‰¾å‡ºç·Šé„°çš„ç›¸åŒå•†å“åç¨±+ç›¸åŒå„²ä½é …ç›®
                const sameItems = [];
                let currentIndex = originalIndex;
                
                // å‘å‰æŸ¥æ‰¾ç·Šé„°çš„ç›¸åŒé …ç›®
                while (currentIndex >= 0 && 
                       (data[currentIndex][1] || '') === productName && 
                       (data[currentIndex][4] || '') === location && 
                       !processed.has(currentIndex)) {
                    sameItems.unshift({
                        originalIndex: currentIndex,
                        row: data[currentIndex]
                    });
                    processed.add(currentIndex);
                    currentIndex--;
                }
                
                // å‘å¾ŒæŸ¥æ‰¾ç·Šé„°çš„ç›¸åŒé …ç›®
                currentIndex = originalIndex + 1;
                while (currentIndex < data.length && 
                       (data[currentIndex][1] || '') === productName && 
                       (data[currentIndex][4] || '') === location && 
                       !processed.has(currentIndex)) {
                    sameItems.push({
                        originalIndex: currentIndex,
                        row: data[currentIndex]
                    });
                    processed.add(currentIndex);
                    currentIndex++;
                }
                
                if (sameItems.length > 0) {
                    // æŒ‰åŸå§‹é †åºæ’åº
                    sameItems.sort((a, b) => a.originalIndex - b.originalIndex);
                    
                    // å°‡æ¯ä¸€ç­†è³‡æ–™éƒ½åŠ å…¥çµæœï¼Œä½†æ¨™è¨˜ç‚ºåŒä¸€å€åŸŸ
                    sameItems.forEach((item, index) => {
                        const row = item.row;
                        result.push({
                            originalIndex: item.originalIndex,
                            mainSku: row[0] || '',
                            productName: productName,
                            optionSku: row[2] || '',
                            specName: row[3] || '',
                            location: location,
                            quantity: row[5] || '',
                            note: row[6] || '',
                            status: row[7] || '',
                            shortageQty: row[8] || '',
                            stockQty: row[9] || '',
                            userNote: (row[10] && typeof row[10] === 'string') ? row[10] : '', // Kæ¬„ä½çš„å‚™è¨»
                            isGroupStart: index === 0, // æ˜¯å¦ç‚ºç¾¤çµ„é–‹å§‹
                            isGroupEnd: index === sameItems.length - 1, // æ˜¯å¦ç‚ºç¾¤çµ„çµæŸ
                            groupSize: sameItems.length, // ç¾¤çµ„å¤§å°
                            groupIndex: index // åœ¨ç¾¤çµ„ä¸­çš„ç´¢å¼•
                        });
                    });
                }
            });
            
            // æŒ‰åŸå§‹é †åºæ’åºçµæœ
            result.sort((a, b) => a.originalIndex - b.originalIndex);
            
            return result;
        }

        // æ¸²æŸ“å•†å“åˆ—è¡¨
        function renderProducts() {
            const productList = document.getElementById('productList');
            const loadingDiv = document.getElementById('loadingDiv');
            
            if (productsData.length === 0) {
                loadingDiv.textContent = 'æš«ç„¡å•†å“è³‡æ–™';
                return;
            }

            loadingDiv.style.display = 'none';
            productList.style.display = 'block';
            
                        const processedProducts = processProductsData(productsData);
            
            // æŒ‰å•†å“åç¨±+å„²ä½åˆ†çµ„æ¸²æŸ“
            const productGroups = new Map();
            processedProducts.forEach(product => {
                const groupKey = `${product.productName}|||${product.location}`;
                if (!productGroups.has(groupKey)) {
                    productGroups.set(groupKey, []);
                }
                productGroups.get(groupKey).push(product);
            });
            
            productList.innerHTML = Array.from(productGroups.entries()).map(([groupKey, products]) => {
                // æª¢æŸ¥æ˜¯å¦ç‚ºç·Šé„°çš„ç¾¤çµ„ï¼ˆåªæœ‰ä¸€å€‹ç¾¤çµ„ä¸”å¤§å°å¤§æ–¼1ï¼‰
                const isGrouped = products.length > 1 && products.every(p => p.groupSize > 1);
                const firstProduct = products[0];
                
                return `
                    ${isGrouped ? `<div class="product-group">
                        <div class="product-group-header">
                            ${firstProduct.location || 'æœªè¨­å®šå„²ä½'} (${products.length}ç­†)
                        </div>` : ''}
                    ${products.map(product => {
                        const { originalIndex, mainSku, productName, optionSku, specName, location, quantity, note, status, shortageQty, stockQty, userNote, isGroupStart, isGroupEnd, groupSize, groupIndex } = product;
                        
                        // èª¿è©¦ä¿¡æ¯ï¼šæª¢æŸ¥ç¬¬ä¸€å€‹ç”¢å“çš„userNote
                        if (originalIndex === 0) {
                            console.log('ç¬¬ä¸€å€‹ç”¢å“çš„userNote:', userNote, 'typeof:', typeof userNote);
                        }
                        
                            
                            let cardClass = '';
                            let statusText = '';
                            let buttonHtml = '';
                            
                            if (status === 'å·²æª¢è²¨') {
                                cardClass = 'checked';
                                statusText = 'âœ“ å·²æª¢è²¨';
                            } else if (status === 'ç¼ºé‡') {
                                cardClass = 'shortage';
                                statusText = `âš ï¸ ç¼ºé‡${shortageQty ? ` (${shortageQty})` : ''}`;
                            } else if (status === 'è¦è£œè²¨') {
                                cardClass = 'restock';
                                statusText = `ğŸ”„ è¦è£œè²¨${stockQty ? ` (åº«å­˜:${stockQty})` : ''}`;
                            } else if (status === 'å€‰ä½éŒ¯') {
                                cardClass = 'position-error';
                                statusText = 'ğŸ“ å€‰ä½éŒ¯';
                            }
                            
                            // æ°¸é é¡¯ç¤ºæ‰€æœ‰æ“ä½œæŒ‰éµï¼Œä½†æ ¹æ“šç•¶å‰ç‹€æ…‹èª¿æ•´æ¨£å¼
                            buttonHtml = `
                                <button class="action-btn btn-checked ${status === 'å·²æª¢è²¨' ? 'active' : ''}" onclick="setStatus(${originalIndex}, 'å·²æª¢è²¨')">å·²æª¢è²¨</button>
                                <button class="action-btn btn-shortage ${status === 'ç¼ºé‡' ? 'active' : ''}" onclick="showQuantityModal(${originalIndex}, 'shortage')">ç¼ºé‡</button>
                                <button class="action-btn btn-restock ${status === 'è¦è£œè²¨' ? 'active' : ''}" onclick="showQuantityModal(${originalIndex}, 'restock')">è¦è£œè²¨</button>
                                <button class="action-btn btn-position-error ${status === 'å€‰ä½éŒ¯' ? 'active' : ''}" onclick="setStatus(${originalIndex}, 'å€‰ä½éŒ¯')">å€‰ä½éŒ¯</button>
                                <button class="action-btn btn-note" onclick="showNoteModal(${originalIndex})">å‚™è¨»</button>
                            `;
                            
                                        return `
                            <div class="variant-card ${cardClass}" id="card-${originalIndex}">
                                <div class="variant-header">
                                    <div class="location-primary">ğŸ“ ${location || 'æœªè¨­å®šå„²ä½'}</div>
                                    <div class="spec-name">${productName}</div>
                                    <div class="option-sku-quantity">
                                        <span class="option-sku">${specName}${optionSku ? ' (' + optionSku + ')' : ''}</span>
                                        <span class="quantity-display">ğŸ“¦ ${quantity}</span>
                                    </div>
                                    ${groupSize > 1 ? `
                                    <div style="font-size: 12px; color: #666; margin-top: 8px;">
                                        ç¾¤çµ„ ${groupIndex + 1}/${groupSize}
                                    </div>` : ''}
                                </div>
                                ${note && note.trim() ? `
                                <div class="variant-details">
                                    <div class="detail-row">
                                        <span class="detail-icon">ğŸ“</span>
                                        <span class="detail-text">${note.trim()}</span>
                                    </div>
                                </div>` : ''}
                                ${(() => {
                                    const noteToShow = userNote && typeof userNote === 'string' ? userNote.trim() : String(userNote || '').trim();
                                    if (originalIndex === 0) {
                                        console.log('å‚™è¨»é¡¯ç¤ºæª¢æŸ¥ - userNote:', userNote, 'noteToShow:', noteToShow, 'will show:', !!noteToShow);
                                    }
                                    return noteToShow ? `
                                    <div class="variant-details">
                                        <div class="detail-row">
                                            <span class="detail-icon">ğŸ’¬</span>
                                            <span class="detail-text">${noteToShow}</span>
                                        </div>
                                    </div>` : '';
                                })()}
                                ${statusText ? `<div class="status-display">${statusText}</div>` : ''}
                                <div class="action-buttons">
                                    ${buttonHtml}
                                </div>
                            </div>
                        `;
                    }).join('')}
                    ${isGrouped ? `</div>` : ''}
                `;
            }).join('');
            
            // æ›´æ–°æœªè™•ç†é …ç›®è¨ˆæ•¸
            setTimeout(updatePendingCount, 100);
        }

        // è¨­å®šç‹€æ…‹ (å…ˆæ›´æ–°UIå†ä¸Šå‚³)
        async function setStatus(rowIndex, status) {
            const product = productsData[rowIndex];
            const productName = product[1] || ''; // Bæ¬„ä½
            const specName = product[3] || ''; // Dæ¬„ä½
            const currentStatus = product[7] || '';
            
            // å¦‚æœé»æ“Šçš„æ˜¯ç•¶å‰ç‹€æ…‹ï¼Œå‰‡åˆ‡æ›å›æœªè™•ç†ç‹€æ…‹
            if (currentStatus === status) {
                // åˆ‡æ›å›æœªè™•ç†ç‹€æ…‹
                restoreStatus(rowIndex);
                return;
            }
            
            // 1. ç«‹å³æ›´æ–°æœ¬åœ°è³‡æ–™å’ŒUI (åŒ…æ‹¬æ‰€æœ‰é‡è¤‡é …ç›®)
            productsData[rowIndex][7] = status;
            
            // æ›´æ–°æ‰€æœ‰ç›¸åŒå•†å“åç¨±+è¦æ ¼åç¨±çš„é‡è¤‡é …ç›®
            productsData.forEach((row, index) => {
                if (index !== rowIndex && row[1] === productName && row[3] === specName) {
                    row[7] = status;
                }
            });
            
            // é‡æ–°æ¸²æŸ“ä¸¦ä¿æŒç•¶å‰ç¯©é¸ç‹€æ…‹
            renderProducts();
            applyFilters();
            
            // 2. æ¨™è¨˜æœ¬åœ°æ›´æ–°
            markLocalUpdate(productName, specName, 'status');
            
            // 3. åœ¨èƒŒæ™¯ä¸Šå‚³è³‡æ–™ (æ‰¹æ¬¡è™•ç†)
            showSyncIndicator('uploading', 'â¬†ï¸ ä¸Šå‚³ä¸­...');
            try {
                const result = await jsonpRequest(GAS_WEB_APP_URL, {
                    action: 'batchUpdate',
                    sheetId: SHEET_ID,
                    productName: productName,
                    specName: specName,
                    updates: JSON.stringify({
                        H: status,
                        I: '',
                        J: ''
                    })
                });
                
                if (result.success) {
                    updateSyncStatus('success', 'è³‡æ–™å·²åŒæ­¥');
                    showSyncIndicator('success', 'âœ… å·²åŒæ­¥');
                } else {
                    throw new Error(result.error || 'ä¸Šå‚³å¤±æ•—');
                }
            } catch (error) {
                // ä¸Šå‚³å¤±æ•—æ™‚æ¢å¾©UIç‹€æ…‹
                productsData[rowIndex][7] = '';
                // æ¢å¾©æ‰€æœ‰é‡è¤‡é …ç›®çš„ç‹€æ…‹
                productsData.forEach((row, index) => {
                    if (index !== rowIndex && row[1] === productName && row[3] === specName) {
                        row[7] = '';
                    }
                });
                renderProducts();
                applyFilters();
                updateSyncStatus('error', 'ä¸Šå‚³å¤±æ•—ï¼Œè«‹é‡è©¦');
                showSyncIndicator('error', 'âŒ ä¸Šå‚³å¤±æ•—');
                alert('ä¸Šå‚³å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }

        // æ¢å¾©ç‹€æ…‹ (å…ˆæ›´æ–°UIå†ä¸Šå‚³)
        async function restoreStatus(rowIndex) {
            const product = productsData[rowIndex];
            const productName = product[1] || ''; // Bæ¬„ä½
            const specName = product[3] || ''; // Dæ¬„ä½
            

            
            // 1. ç«‹å³æ›´æ–°æœ¬åœ°è³‡æ–™å’ŒUI (åŒ…æ‹¬æ‰€æœ‰é‡è¤‡é …ç›®)
            const oldStatus = {
                status: productsData[rowIndex][7],
                shortage: productsData[rowIndex][8],
                stock: productsData[rowIndex][9]
            };
            
            productsData[rowIndex][7] = '';
            productsData[rowIndex][8] = '';
            productsData[rowIndex][9] = '';
            
            // æ¸…é™¤æ‰€æœ‰ç›¸åŒå•†å“åç¨±+è¦æ ¼åç¨±çš„é‡è¤‡é …ç›®
            productsData.forEach((row, index) => {
                if (index !== rowIndex && row[1] === productName && row[3] === specName) {
                    row[7] = '';
                    row[8] = '';
                    row[9] = '';
                }
            });
            
            // é‡æ–°æ¸²æŸ“ä¸¦ä¿æŒç•¶å‰ç¯©é¸ç‹€æ…‹
            renderProducts();
            applyFilters();
            
            // 2. æ¨™è¨˜æœ¬åœ°æ›´æ–°
            markLocalUpdate(productName, specName, 'restore');
            
            // 3. åœ¨èƒŒæ™¯ä¸Šå‚³è³‡æ–™ (æ‰¹æ¬¡æ¸…é™¤HIJ)
            try {
                const result = await jsonpRequest(GAS_WEB_APP_URL, {
                    action: 'batchUpdate',
                    sheetId: SHEET_ID,
                    productName: productName,
                    specName: specName,
                    updates: JSON.stringify({
                        H: '',
                        I: '',
                        J: ''
                    })
                });
                
                if (result.success) {
                    updateSyncStatus('success', 'è³‡æ–™å·²åŒæ­¥');
                } else {
                    throw new Error(result.error || 'æ¢å¾©å¤±æ•—');
                }
            } catch (error) {
                // ä¸Šå‚³å¤±æ•—æ™‚æ¢å¾©åŸç‹€æ…‹
                productsData[rowIndex][7] = oldStatus.status;
                productsData[rowIndex][8] = oldStatus.shortage;
                productsData[rowIndex][9] = oldStatus.stock;
                
                // æ¢å¾©æ‰€æœ‰é‡è¤‡é …ç›®çš„ç‹€æ…‹
                productsData.forEach((row, index) => {
                    if (index !== rowIndex && row[1] === productName && row[3] === specName) {
                        row[7] = oldStatus.status;
                        row[8] = oldStatus.shortage;
                        row[9] = oldStatus.stock;
                    }
                });
                
                renderProducts();
                applyFilters();
                updateSyncStatus('error', 'æ¢å¾©å¤±æ•—ï¼Œè«‹é‡è©¦');
                alert('æ¢å¾©å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }

        // é¡¯ç¤ºæ•¸é‡è¼¸å…¥æ¨¡æ…‹æ¡†
        function showQuantityModal(rowIndex, actionType) {
            currentRowIndex = rowIndex;
            currentActionType = actionType;
            selectedUnit = 'å…¥'; // é‡è¨­ç‚ºé è¨­å–®ä½
            
            const modal = document.getElementById('quantityModal');
            const title = document.getElementById('modalTitle');
            const input = document.getElementById('quantityInput');
            
            title.textContent = actionType === 'shortage' ? 'è¼¸å…¥ç¼ºé‡æ•¸é‡' : 'è¼¸å…¥ç›®å‰åº«å­˜æ•¸é‡';
            input.value = '';
            
            // é‡è¨­å–®ä½æŒ‰éˆ•ç‹€æ…‹
            document.getElementById('unitPcs').classList.add('active');
            document.getElementById('unitBox').classList.remove('active');
            
            modal.style.display = 'block';
        }

        // æ•¸å­—è¼¸å…¥åŠŸèƒ½
        function addNumber(num) {
            const input = document.getElementById('quantityInput');
            input.value += num;
        }

        function deleteNumber() {
            const input = document.getElementById('quantityInput');
            input.value = input.value.slice(0, -1);
        }

        function clearNumber() {
            const input = document.getElementById('quantityInput');
            input.value = '';
        }

        // é¸æ“‡å–®ä½
        function selectUnit(unit) {
            selectedUnit = unit;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.unit-btn').forEach(btn => btn.classList.remove('active'));
            
            if (unit === 'å…¥') {
                document.getElementById('unitPcs').classList.add('active');
            } else {
                document.getElementById('unitBox').classList.add('active');
            }
        }

        // ç¢ºèªæ•¸é‡ (å…ˆæ›´æ–°UIå†ä¸Šå‚³)
        async function confirmQuantity() {
            const quantity = document.getElementById('quantityInput').value;
            if (!quantity) {
                alert('è«‹è¼¸å…¥æ•¸é‡');
                return;
            }

            const product = productsData[currentRowIndex];
            const productName = product[1] || ''; // Bæ¬„ä½
            const specName = product[3] || ''; // Dæ¬„ä½
            
            // çµ„åˆæ•¸é‡å’Œå–®ä½
            const quantityWithUnit = `${quantity}${selectedUnit}`;
            
            // 1. ç«‹å³æ›´æ–°æœ¬åœ°è³‡æ–™å’ŒUI (åŒ…æ‹¬æ‰€æœ‰é‡è¤‡é …ç›®)
            if (currentActionType === 'shortage') {
                productsData[currentRowIndex][7] = 'ç¼ºé‡';
                productsData[currentRowIndex][8] = quantityWithUnit;
                
                // æ›´æ–°æ‰€æœ‰ç›¸åŒå•†å“åç¨±+è¦æ ¼åç¨±çš„é‡è¤‡é …ç›®
                productsData.forEach((row, index) => {
                    if (index !== currentRowIndex && row[1] === productName && row[3] === specName) {
                        row[7] = 'ç¼ºé‡';
                        row[8] = quantityWithUnit;
                    }
                });
            } else if (currentActionType === 'restock') {
                productsData[currentRowIndex][7] = 'è¦è£œè²¨';
                productsData[currentRowIndex][9] = quantityWithUnit;
                
                // æ›´æ–°æ‰€æœ‰ç›¸åŒå•†å“åç¨±+è¦æ ¼åç¨±çš„é‡è¤‡é …ç›®
                productsData.forEach((row, index) => {
                    if (index !== currentRowIndex && row[1] === productName && row[3] === specName) {
                        row[7] = 'è¦è£œè²¨';
                        row[9] = quantityWithUnit;
                    }
                });
            }
            
            // é‡æ–°æ¸²æŸ“ä¸¦ä¿æŒç•¶å‰ç¯©é¸ç‹€æ…‹
            renderProducts();
            applyFilters();
            
            // ä¿å­˜ actionType å’Œ rowIndexï¼Œå› ç‚º closeModal() æœƒé‡ç½®å®ƒå€‘
            const actionTypeToUpload = currentActionType;
            const rowIndexToUpload = currentRowIndex;
            
            closeModal();
            
            // 2. æ¨™è¨˜æœ¬åœ°æ›´æ–°
            markLocalUpdate(productName, specName, actionTypeToUpload);
            
            // 3. åœ¨èƒŒæ™¯ä¸Šå‚³è³‡æ–™ (æ‰¹æ¬¡è™•ç†HIJæ¬„ä½)
            showSyncIndicator('uploading', 'â¬†ï¸ ä¸Šå‚³ä¸­...');
            try {
                let updates = {};
                
                if (actionTypeToUpload === 'shortage') {
                    updates = {
                        H: 'ç¼ºé‡',
                        I: quantityWithUnit,
                        J: ''
                    };
                } else if (actionTypeToUpload === 'restock') {
                    updates = {
                        H: 'è¦è£œè²¨',
                        I: '',
                        J: quantityWithUnit
                    };
                }
                
                const result = await jsonpRequest(GAS_WEB_APP_URL, {
                    action: 'batchUpdate',
                    sheetId: SHEET_ID,
                    productName: productName,
                    specName: specName,
                    updates: JSON.stringify(updates)
                });
                
                if (result.success) {
                    updateSyncStatus('success', 'è³‡æ–™å·²åŒæ­¥');
                    showSyncIndicator('success', 'âœ… å·²åŒæ­¥');
                } else {
                    throw new Error(result.error || 'ä¸Šå‚³å¤±æ•—');
                }
            } catch (error) {
                // ä¸Šå‚³å¤±æ•—æ™‚æ¸…é™¤ç‹€æ…‹ (åŒ…æ‹¬æ‰€æœ‰é‡è¤‡é …ç›®)
                productsData[rowIndexToUpload][7] = '';
                productsData[rowIndexToUpload][8] = '';
                productsData[rowIndexToUpload][9] = '';
                
                // æ¸…é™¤æ‰€æœ‰é‡è¤‡é …ç›®çš„ç‹€æ…‹
                productsData.forEach((row, index) => {
                    if (index !== rowIndexToUpload && row[1] === productName && row[3] === specName) {
                        row[7] = '';
                        row[8] = '';
                        row[9] = '';
                    }
                });
                
                renderProducts();
                applyFilters();
                updateSyncStatus('error', 'ä¸Šå‚³å¤±æ•—ï¼Œè«‹é‡è©¦');
                showSyncIndicator('error', 'âŒ ä¸Šå‚³å¤±æ•—');
                alert('ä¸Šå‚³å¤±æ•—ï¼Œè«‹é‡è©¦');
            }
        }

        // é—œé–‰æ¨¡æ…‹æ¡†
        function closeModal() {
            document.getElementById('quantityModal').style.display = 'none';
            currentRowIndex = null;
            currentActionType = null;
            selectedUnit = 'å…¥'; // é‡è¨­å–®ä½
        }

        // é¡¯ç¤ºå‚™è¨»è¼¸å…¥æ¡†
        function showNoteModal(rowIndex) {
            currentRowIndex = rowIndex;
            const product = productsData[rowIndex];
            const currentNote = product[10] || ''; // Kæ¬„ä½æ˜¯ç´¢å¼•10
            
            // è¨­å®šç•¶å‰å‚™è¨»å…§å®¹
            document.getElementById('noteInput').value = currentNote;
            
            // é¡¯ç¤ºmodal
            document.getElementById('noteModal').style.display = 'block';
        }

        // é—œé–‰å‚™è¨»è¼¸å…¥æ¡†
        function closeNoteModal() {
            document.getElementById('noteModal').style.display = 'none';
            document.getElementById('noteInput').value = '';
            currentRowIndex = null;
        }

        // ç¢ºèªå‚™è¨»
        async function confirmNote() {
            const noteText = document.getElementById('noteInput').value.trim();
            const product = productsData[currentRowIndex];
            const productName = product[1];
            const specName = product[3];
            const originalNote = product[10] || ''; // ä¿å­˜åŸå§‹å‚™è¨»
            
            try {
                // 1. å…ˆæ›´æ–°æœ¬åœ°æ•¸æ“š
                productsData[currentRowIndex][10] = noteText; // Kæ¬„ä½æ˜¯ç´¢å¼•10
                
                // 2. é‡æ–°æ¸²æŸ“
                renderProducts();
                applyFilters();
                
                // 3. é—œé–‰modal
                closeNoteModal();
                
                // 4. èƒŒæ™¯ä¸Šå‚³åˆ°Google Sheets
                showSyncIndicator('uploading', 'â¬†ï¸ ä¸Šå‚³ä¸­...');
                
                const result = await jsonpRequest(GAS_WEB_APP_URL, {
                    action: 'update',
                    sheetId: SHEET_ID,
                    productName: productName,
                    specName: specName,
                    column: 'K',
                    value: noteText
                });
                
                console.log('å‚™è¨»ä¸Šå‚³çµæœ:', result); // èª¿è©¦ä¿¡æ¯
                
                if (result && result.success) {
                    updateSyncStatus('success', 'å‚™è¨»å·²ä¿å­˜');
                    showSyncIndicator('success', 'âœ… å‚™è¨»å·²åŒæ­¥');
                } else {
                    throw new Error(result?.error || 'å‚™è¨»ä¿å­˜å¤±æ•—');
                }
            } catch (error) {
                console.error('å‚™è¨»ä¿å­˜éŒ¯èª¤:', error); // èª¿è©¦ä¿¡æ¯
                // å¤±æ•—æ™‚æ¢å¾©åŸå§‹å€¼
                productsData[currentRowIndex][10] = originalNote;
                renderProducts();
                applyFilters();
                showSyncIndicator('error', 'âŒ å‚™è¨»ä¿å­˜å¤±æ•—');
                alert(`å‚™è¨»ä¿å­˜å¤±æ•—: ${error.message}`);
            }
        }

        // è‡ªå‹•åˆ·æ–° (æ™ºèƒ½åŒæ­¥ï¼Œé¿å…è¡çª)
        async function refreshProducts() {
            if (isUpdating) return; // å¦‚æœæ­£åœ¨æ›´æ–°ä¸­ï¼Œè·³é
            
            try {
                const result = await jsonpRequest(GAS_WEB_APP_URL, {
                    action: 'read',
                    sheetId: SHEET_ID
                });
                
                if (result.success && result.data && result.data.length > 1) {
                    const newData = result.data.slice(1);
                    let hasChanges = false;
                    
                    newData.forEach((newRow, index) => {
                        if (index < productsData.length) {
                            const currentRow = productsData[index];
                            const productName = newRow[1] || '';
                            const specName = newRow[3] || '';
                            
                            // æ¯”è¼ƒA-Gæ¬„ä½æ˜¯å¦æœ‰è®ŠåŒ–
                            for (let i = 0; i < 7; i++) {
                                if (newRow[i] !== currentRow[i]) {
                                    hasChanges = true;
                                    currentRow[i] = newRow[i]; // æ›´æ–°åŸºæœ¬è³‡æ–™
                                }
                            }
                            
                            // æª¢æŸ¥H-Jæ¬„ä½æ›´æ–°ï¼Œä½†ä¿è­·æœ€è¿‘çš„æœ¬åœ°æ›´æ–°
                            const isRecentLocal = isRecentLocalUpdate(productName, specName, 5000); // 5ç§’å…§ä¿è­·
                            
                            if (!isRecentLocal) {
                                // æ²’æœ‰æœ€è¿‘çš„æœ¬åœ°æ›´æ–°ï¼Œå®‰å…¨åœ°æ›´æ–°é ç«¯ç‹€æ…‹
                                if (newRow[7] !== currentRow[7] || 
                                    newRow[8] !== currentRow[8] || 
                                    newRow[9] !== currentRow[9]) {
                                    
                                    currentRow[7] = newRow[7];
                                    currentRow[8] = newRow[8];
                                    currentRow[9] = newRow[9];
                                    hasChanges = true;
                                }
                            }
                        }
                    });
                    
                    // è™•ç†æ–°å¢çš„å•†å“
                    if (newData.length > productsData.length) {
                        for (let i = productsData.length; i < newData.length; i++) {
                            productsData.push(newData[i]);
                            hasChanges = true;
                        }
                    }
                    
                    if (hasChanges) {
                        renderProducts();
                        updateSyncStatus('success', 'è³‡æ–™å·²åŒæ­¥');
                        showSyncIndicator('success', 'ğŸ”„ å·²æ›´æ–°');
                    }
                }
            } catch (error) {
                // è‡ªå‹•åˆ·æ–°å¤±æ•—ï¼Œéœé»˜è™•ç†
            }
        }

        // æ›´æ–°åŒæ­¥ç‹€æ…‹ (ç°¡åŒ–ç‰ˆæœ¬ - åªä½¿ç”¨å³ä¸Šè§’æŒ‡ç¤ºå™¨)
        function updateSyncStatus(type, message) {
            // åŒæ­¥ç‹€æ…‹ç¾åœ¨åªé€šéå³ä¸Šè§’çš„ syncIndicator é¡¯ç¤º
            showSyncIndicator(type, message);
        }

        // é¡¯ç¤ºåŒæ­¥æŒ‡ç¤ºå™¨
        function showSyncIndicator(type, message) {
            const indicator = document.getElementById('syncIndicator');
            
            // æ¸…é™¤ä¹‹å‰çš„timeout
            if (syncIndicatorTimeout) {
                clearTimeout(syncIndicatorTimeout);
            }
            
            // è¨­ç½®æ¨£å¼å’Œå…§å®¹
            indicator.className = `sync-indicator ${type}`;
            indicator.textContent = message;
            
            // è‡ªå‹•éš±è—ï¼ˆé™¤äº†uploadingç‹€æ…‹ï¼‰
            if (type !== 'uploading') {
                syncIndicatorTimeout = setTimeout(() => {
                    indicator.classList.add('hidden');
                }, 2000);
            }
        }

        // æœå°‹åŠŸèƒ½
        function filterProducts() {
            const searchBox = document.getElementById('searchBox');
            const clearBtn = document.getElementById('searchClearBtn');
            searchQuery = searchBox.value.toLowerCase().trim();
            
            // é¡¯ç¤ºæˆ–éš±è—æ¸…é™¤æŒ‰éµ
            if (searchQuery) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }
            
            applyFilters();
        }

        // æ¸…é™¤æœå°‹
        function clearSearch() {
            const searchBox = document.getElementById('searchBox');
            const clearBtn = document.getElementById('searchClearBtn');
            
            searchBox.value = '';
            searchQuery = '';
            clearBtn.classList.add('hidden');
            
            applyFilters();
        }

        // è¨­å®šç¯©é¸ç‹€æ…‹
        function setFilter(filterType) {
            currentFilter = filterType;
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            
            // åªåœ¨å°æ‡‰çš„æŒ‰éˆ•å­˜åœ¨æ™‚æ‰è¨­å®š active ç‹€æ…‹
            const targetBtn = document.getElementById(`filter${filterType.charAt(0).toUpperCase() + filterType.slice(1)}`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            applyFilters();
        }

        // æ‡‰ç”¨ç¯©é¸å’Œæœå°‹
        function applyFilters() {
            const productCards = document.querySelectorAll('.variant-card');
            
            productCards.forEach(card => {
                const cardId = card.id;
                const rowIndex = parseInt(cardId.replace('card-', ''));
                const product = productsData[rowIndex];
                
                if (!product) return;
                
                const productName = (product[1] || '').toLowerCase();
                const specName = (product[3] || '').toLowerCase();
                const optionSku = (product[2] || '').toLowerCase();
                const mainSku = (product[0] || '').toLowerCase();
                const note = (product[6] || '').toLowerCase();
                const status = product[7] || '';
                
                // æœå°‹åŒ¹é… (åŒ…å«å‚™è¨»)
                const searchMatch = !searchQuery || 
                    productName.includes(searchQuery) ||
                    specName.includes(searchQuery) ||
                    optionSku.includes(searchQuery) ||
                    mainSku.includes(searchQuery) ||
                    note.includes(searchQuery);
                
                // ç‹€æ…‹ç¯©é¸
                let statusMatch = true;
                if (currentFilter === 'shortage') {
                    statusMatch = status === 'ç¼ºé‡';
                } else if (currentFilter === 'restock') {
                    statusMatch = status === 'è¦è£œè²¨';
                } else if (currentFilter === 'pending') {
                    statusMatch = !status || status === '';
                } else if (currentFilter === 'position-error') {
                    statusMatch = status === 'å€‰ä½éŒ¯';
                }
                
                // é¡¯ç¤ºæˆ–éš±è—å¡ç‰‡
                if (searchMatch && statusMatch) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
            
            // è™•ç†å•†å“ç¾¤çµ„çš„é¡¯ç¤º/éš±è—
            const productGroups = document.querySelectorAll('.product-group');
            productGroups.forEach(group => {
                const visibleCards = group.querySelectorAll('.variant-card[style*="display: block"], .variant-card:not([style*="display: none"])');
                if (visibleCards.length === 0) {
                    group.style.display = 'none';
                } else {
                    group.style.display = 'block';
                }
            });
            
            // æ›´æ–°æœªè™•ç†é …ç›®è¨ˆæ•¸
            updatePendingCount();
        }


        // å°èˆªåˆ°æœªè™•ç†é …ç›®
        function navigateToPending(direction) {
            const visibleCards = Array.from(document.querySelectorAll('.variant-card')).filter(card => {
                return card.style.display !== 'none';
            });
            
            // å–å¾—æ‰€æœ‰æœªè™•ç†é …ç›®
            const pendingCards = visibleCards.filter(card => {
                const cardId = card.id;
                const rowIndex = parseInt(cardId.replace('card-', ''));
                const product = productsData[rowIndex];
                return product && (!product[7] || product[7] === '');
            });
            
            if (pendingCards.length === 0) {
                alert('æ²’æœ‰æ‰¾åˆ°æœªè™•ç†çš„é …ç›®');
                return;
            }
            
            // è¨ˆç®—æ¯å€‹å¡ç‰‡çš„çµ•å°ä½ç½®ä¸¦æ’åº
            const cardsWithPosition = pendingCards.map(card => {
                const rect = card.getBoundingClientRect();
                return {
                    card: card,
                    absoluteTop: rect.top + window.scrollY
                };
            }).sort((a, b) => a.absoluteTop - b.absoluteTop);
            
            // å–å¾—ç›®å‰è¦–çª—ä½ç½®
            const currentScrollY = window.scrollY;
            const windowHeight = window.innerHeight;
            const currentViewTop = currentScrollY;
            const currentViewBottom = currentScrollY + windowHeight;
            const currentViewCenter = currentScrollY + windowHeight / 2;
            
            let targetCard = null;
            
            if (direction === 'up') {
                // å‘ä¸Šå°‹æ‰¾ï¼šæ‰¾åˆ°ç•¶å‰è¦–çª—ä¸Šæ–¹æœ€è¿‘çš„æœªè™•ç†é …ç›®
                let foundCard = null;
                
                // å¾å¾Œå¾€å‰æ‰¾ï¼ˆå¾ä¸‹å¾€ä¸Šæ‰¾ï¼‰ï¼Œæ‰¾åˆ°ç¬¬ä¸€å€‹åœ¨ç•¶å‰è¦–çª—ä¸Šæ–¹çš„é …ç›®
                for (let i = cardsWithPosition.length - 1; i >= 0; i--) {
                    const item = cardsWithPosition[i];
                    if (item.absoluteTop < currentViewTop - 50) { // 50px çš„ç·©è¡å€
                        foundCard = item.card;
                        break;
                    }
                }
                
                if (foundCard) {
                    targetCard = foundCard;
                } else {
                    // å¦‚æœæ²’æœ‰ä¸Šæ–¹çš„ï¼Œç’°ç¹åˆ°æœ€å¾Œä¸€å€‹ï¼ˆæœ€åº•éƒ¨çš„ï¼‰
                    targetCard = cardsWithPosition[cardsWithPosition.length - 1].card;
                }
            } else {
                // å‘ä¸‹å°‹æ‰¾ï¼šæ‰¾åˆ°ç•¶å‰è¦–çª—ä¸‹æ–¹æœ€è¿‘çš„æœªè™•ç†é …ç›®
                let foundCard = null;
                
                // å¾å‰å¾€å¾Œæ‰¾ï¼ˆå¾ä¸Šå¾€ä¸‹æ‰¾ï¼‰ï¼Œæ‰¾åˆ°ç¬¬ä¸€å€‹åœ¨ç•¶å‰è¦–çª—ä¸‹æ–¹çš„é …ç›®
                for (let i = 0; i < cardsWithPosition.length; i++) {
                    const item = cardsWithPosition[i];
                    if (item.absoluteTop > currentViewBottom + 50) { // 50px çš„ç·©è¡å€
                        foundCard = item.card;
                        break;
                    }
                }
                
                if (foundCard) {
                    targetCard = foundCard;
                } else {
                    // å¦‚æœæ²’æœ‰ä¸‹æ–¹çš„ï¼Œç’°ç¹åˆ°ç¬¬ä¸€å€‹ï¼ˆæœ€é ‚éƒ¨çš„ï¼‰
                    targetCard = cardsWithPosition[0].card;
                }
            }
            
            if (targetCard) {
                // å¹³æ»‘æ»¾å‹•åˆ°ç›®æ¨™å¡ç‰‡
                const rect = targetCard.getBoundingClientRect();
                const cardTop = rect.top + window.scrollY;
                const offset = 100; // è·é›¢é ‚éƒ¨çš„åç§»é‡
                
                window.scrollTo({
                    top: cardTop - offset,
                    behavior: 'smooth'
                });
                
                // æ·»åŠ é«˜äº®æ•ˆæœ
                targetCard.style.transform = 'scale(1.02)';
                targetCard.style.boxShadow = '0 10px 40px rgba(102, 126, 234, 0.4)';
                
                setTimeout(() => {
                    targetCard.style.transform = '';
                    targetCard.style.boxShadow = '';
                }, 1000);
            }
        }

        // æ›´æ–°æœªè™•ç†é …ç›®è¨ˆæ•¸
        function updatePendingCount() {
            const pendingCards = Array.from(document.querySelectorAll('.variant-card')).filter(card => {
                const cardId = card.id;
                const rowIndex = parseInt(cardId.replace('card-', ''));
                const product = productsData[rowIndex];
                return product && (!product[7] || product[7] === '');
            });
            
            const countBadge = document.getElementById('pendingCountBadge');
            const count = pendingCards.length;
            
            if (count > 0) {
                countBadge.textContent = count;
                countBadge.style.display = 'flex';
            } else {
                countBadge.style.display = 'none';
            }
        }


    </script>
</body>
</html>