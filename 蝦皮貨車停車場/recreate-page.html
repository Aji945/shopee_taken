<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¦çš®è²¨è»Šä½ç½® - é‡å»ºåˆ—å°é é¢</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .input-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        
        .input-section h2 {
            font-size: 20px;
            margin-bottom: 20px;
            color: #333;
        }
        
        .instructions {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .instructions h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #1976d2;
        }
        
        .instructions ol {
            margin-left: 20px;
            color: #555;
        }
        
        .instructions li {
            margin-bottom: 5px;
        }
        
        #htmlInput {
            width: 100%;
            height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            resize: vertical;
            transition: border-color 0.3s;
        }
        
        #htmlInput:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn:active {
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f56565, #e53e3e);
        }
        
        .output-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: none;
        }
        
        .output-section.active {
            display: block;
        }
        
        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .output-header h2 {
            font-size: 20px;
            color: #333;
        }
        
        #outputFrame {
            width: 100%;
            height: 800px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
        }
        
        .status-message {
            padding: 12px 20px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
            display: none;
        }
        
        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* åˆ—å°é é¢æ¨£å¼ä¿ç•™ */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            .header, .input-section, .button-group, .output-header {
                display: none;
            }
            
            .output-section {
                box-shadow: none;
                padding: 0;
            }
            
            #outputFrame {
                border: none;
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸšš è¦çš®è²¨è»Šä½ç½®æŸ¥è©¢ - é‡å»ºåˆ—å°é é¢</h1>
            <p>å°‡ about:blank åˆ—å°é é¢çš„ HTML è²¼ä¸Šï¼Œå³å¯åœ¨æ­¤é‡æ–°é¡¯ç¤ºä¸¦ä½¿ç”¨æ“´å……å¥—ä»¶åŠŸèƒ½</p>
        </div>
        
        <div class="input-section">
            <h2>æ­¥é©Ÿä¸€ï¼šè²¼ä¸Š HTML åŸå§‹ç¢¼</h2>
            
            <div class="instructions">
                <h3>ğŸ“‹ å¦‚ä½•è¤‡è£½åˆ—å°é é¢çš„ HTMLï¼š</h3>
                <ol>
                    <li>åœ¨ about:blank åˆ—å°é é¢æŒ‰ä¸‹ <strong>F12</strong> é–‹å•Ÿé–‹ç™¼è€…å·¥å…·</li>
                    <li>åˆ‡æ›åˆ° <strong>Elements</strong> æˆ– <strong>å…ƒç´ </strong> æ¨™ç±¤</li>
                    <li>åœ¨ <strong>&lt;html&gt;</strong> æ¨™ç±¤ä¸ŠæŒ‰å³éµ</li>
                    <li>é¸æ“‡ <strong>Copy</strong> â†’ <strong>Copy outerHTML</strong> æˆ– <strong>è¤‡è£½</strong> â†’ <strong>è¤‡è£½ outerHTML</strong></li>
                    <li>å°‡è¤‡è£½çš„å…§å®¹è²¼åˆ°ä¸‹æ–¹æ–‡å­—æ¡†</li>
                </ol>
                
                <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px;">
                    <strong>ğŸ’¡ æŒ‰éˆ•èªªæ˜ï¼š</strong><br>
                    â€¢ <strong>ğŸ”„ é‡å»ºé é¢</strong>ï¼šæ¨™æº–æ¨¡å¼ï¼Œæœƒé€²è¡Œæœ€å°åŒ–åŒ…è£<br>
                    â€¢ <strong>ğŸ’¯ å®Œå…¨åŒ¹é…æ¨¡å¼</strong>ï¼šå®Œå…¨ä¸ä¿®æ”¹åŸå§‹HTMLï¼Œä¿æŒ100%ä¸€è‡´çš„æ ¼å¼<br>
                    â€¢ <strong>ğŸšš æƒæè²¨è»Šä½ç½®</strong>ï¼šåœ¨é‡å»ºå¾Œçš„é é¢ä¸­æŸ¥æ‰¾ä¸¦æ¨™è¨˜è²¨è»Šä½ç½®
                </div>
            </div>
            
            <textarea id="htmlInput" placeholder="åœ¨æ­¤è²¼ä¸Šå®Œæ•´çš„ HTML å…§å®¹..."></textarea>
            
            <div class="button-group">
                <button class="btn" onclick="recreatePage()">ğŸ”„ é‡å»ºé é¢</button>
                <button class="btn" onclick="recreatePageExact()" style="background: linear-gradient(135deg, #28a745, #20c997);">ğŸ’¯ å®Œå…¨åŒ¹é…æ¨¡å¼</button>
                <button class="btn btn-secondary" onclick="scanPage()">ğŸšš æƒæè²¨è»Šä½ç½®</button>
                <button class="btn btn-warning" onclick="clearAll()">ğŸ—‘ï¸ æ¸…é™¤</button>
            </div>
            
            <div id="statusMessage" class="status-message"></div>
        </div>
        
        <div id="outputSection" class="output-section">
            <div class="output-header">
                <h2>æ­¥é©ŸäºŒï¼šé‡å»ºçš„é é¢å…§å®¹</h2>
                <button class="btn btn-secondary" onclick="scanPage()">ğŸšš æƒæè²¨è»Šä½ç½®</button>
            </div>
            
            <iframe id="outputFrame" sandbox="allow-same-origin allow-scripts allow-forms allow-popups" style="border: 1px solid #ddd; background: white;"></iframe>
        </div>
    </div>
    
    <script>
        // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';
            
            // 3ç§’å¾Œè‡ªå‹•éš±è—
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }
        
        // é‡å»ºé é¢
        function recreatePage() {
            const htmlContent = document.getElementById('htmlInput').value.trim();
            
            if (!htmlContent) {
                showStatus('è«‹å…ˆè²¼ä¸Š HTML å…§å®¹', 'error');
                return;
            }
            
            try {
                const outputFrame = document.getElementById('outputFrame');
                
                // é©—è­‰HTMLæ ¼å¼
                if (!validateHTML(htmlContent)) {
                    showStatus('âš ï¸ HTML æ ¼å¼å¯èƒ½æœ‰å•é¡Œï¼Œä½†å˜—è©¦ç¹¼çºŒè™•ç†...', 'info');
                }
                
                // å®Œå…¨ä¿æŒåŸå§‹HTMLçµæ§‹ï¼Œä¸åšä»»ä½•ä¿®æ”¹
                let fullHtml = htmlContent;
                
                // å¦‚æœæ˜¯å®Œæ•´çš„HTMLæ–‡æª”ï¼Œç›´æ¥ä½¿ç”¨
                if (htmlContent.toLowerCase().includes('<!doctype') || htmlContent.toLowerCase().includes('<html')) {
                    console.log('ğŸ“ åµæ¸¬åˆ°å®Œæ•´çš„HTMLæ–‡æª”ï¼Œå®Œå…¨ä¿æŒåŸå§‹çµæ§‹');
                    fullHtml = htmlContent;
                } else {
                    console.log('ğŸ“ åµæ¸¬åˆ°HTMLç‰‡æ®µï¼Œå˜—è©¦æœ€å°åŒ–åŒ…è£...');
                    
                    // å°æ–¼HTMLç‰‡æ®µï¼Œä½¿ç”¨æœ€å°çš„åŒ…è£ä»¥ä¿æŒåŸå§‹æ¨£å¼
                    // ä¸æ·»åŠ ä»»ä½•é¡å¤–çš„metaæ¨™ç±¤æˆ–viewportè¨­å®š
                    fullHtml = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>é‡å»ºçš„åˆ—å°é é¢</title>
</head>
<body style="margin:0;padding:0;">
${htmlContent}
</body>
</html>`;
                }
                
                // è¨˜éŒ„HTMLå¤§å°ç”¨æ–¼è¨ºæ–·
                console.log('ğŸ“Š HTMLå¤§å°:', fullHtml.length, 'å­—ç¬¦');
                console.log('ğŸ“Š æ˜¯å¦åŒ…å«CSS:', fullHtml.includes('<style'));
                console.log('ğŸ“Š æ˜¯å¦åŒ…å«è¡¨æ ¼:', fullHtml.includes('<table') || fullHtml.includes('<tr'));
                
                // æ¸…ç©ºiframeå…§å®¹ï¼Œæº–å‚™é‡æ–°è¼‰å…¥
                outputFrame.srcdoc = '';
                
                // ä½¿ç”¨å»¶é²è¼‰å…¥ç¢ºä¿iframeå®Œå…¨æ¸…ç©º
                setTimeout(() => {
                    // å°‡å®Œæ•´HTMLå¯«å…¥iframe
                    outputFrame.onload = function() {
                        console.log('âœ… iframeè¼‰å…¥å®Œæˆ');
                        
                        // ç­‰å¾…iframeå®Œå…¨æ¸²æŸ“
                        setTimeout(() => {
                            // é©—è­‰ä¸¦èª¿æ•´iframeæ¸²æŸ“
                            optimizeIframeRendering();
                            
                            // é©—è­‰iframeå…§å®¹
                            validateIframeContent();
                            
                            // æ³¨å…¥è…³æœ¬
                            injectScriptToIframe();
                            
                            showStatus('âœ… é é¢å·²é‡å»ºæˆåŠŸï¼ç¾åœ¨å¯ä»¥ä½¿ç”¨æƒæåŠŸèƒ½', 'success');
                        }, 500);
                    };
                    
                    outputFrame.onerror = function(error) {
                        console.error('âŒ iframeè¼‰å…¥å¤±æ•—:', error);
                        showStatus('âŒ é é¢è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥HTMLæ ¼å¼', 'error');
                    };
                    
                    // ä½¿ç”¨ srcdoc ä¾†è¨­ç½®iframeå…§å®¹ï¼Œä¿æŒå®Œæ•´çš„HTMLçµæ§‹
                    outputFrame.srcdoc = fullHtml;
                }, 100);
                
                // é¡¯ç¤ºè¼¸å‡ºå€åŸŸ
                document.getElementById('outputSection').classList.add('active');
                
                // è‡ªå‹•æ»¾å‹•åˆ°è¼¸å‡ºå€åŸŸ
                document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('é‡å»ºé é¢å¤±æ•—:', error);
                showStatus('âŒ é‡å»ºé é¢å¤±æ•—ï¼Œè«‹ç¢ºèª HTML æ ¼å¼æ­£ç¢º', 'error');
            }
        }
        
        // å®Œå…¨åŒ¹é…æ¨¡å¼é‡å»ºé é¢
        function recreatePageExact() {
            const htmlContent = document.getElementById('htmlInput').value.trim();
            
            if (!htmlContent) {
                showStatus('è«‹å…ˆè²¼ä¸Š HTML å…§å®¹', 'error');
                return;
            }
            
            try {
                const outputFrame = document.getElementById('outputFrame');
                
                console.log('ğŸ’¯ å•Ÿå‹•å®Œå…¨åŒ¹é…æ¨¡å¼...');
                showStatus('ğŸ’¯ å®Œå…¨åŒ¹é…æ¨¡å¼ï¼šä¿æŒåŸå§‹HTMLå®Œå…¨ä¸è®Š', 'info');
                
                // å®Œå…¨ä¸ä¿®æ”¹åŸå§‹HTMLï¼Œç›´æ¥ä½¿ç”¨
                const exactHtml = htmlContent;
                
                // è¨˜éŒ„è¨ºæ–·ä¿¡æ¯
                console.log('ğŸ“Š å®Œå…¨åŒ¹é…æ¨¡å¼ - HTMLå¤§å°:', exactHtml.length, 'å­—ç¬¦');
                console.log('ğŸ“Š å®Œå…¨åŒ¹é…æ¨¡å¼ - åŸå§‹å…§å®¹é¡å‹:', detectContentType(exactHtml));
                
                // æ¸…ç©ºiframeä¸¦é‡æ–°è¼‰å…¥
                outputFrame.srcdoc = '';
                
                setTimeout(() => {
                    outputFrame.onload = function() {
                        console.log('âœ… å®Œå…¨åŒ¹é…æ¨¡å¼ - iframeè¼‰å…¥å®Œæˆ');
                        
                        setTimeout(() => {
                            // åœ¨å®Œå…¨åŒ¹é…æ¨¡å¼ä¸‹ï¼Œä¸é€²è¡Œä»»ä½•æ¸²æŸ“å„ªåŒ–
                            // åªé©—è­‰å…§å®¹å’Œæ³¨å…¥è…³æœ¬
                            validateIframeContent();
                            injectScriptToIframe();
                            
                            showStatus('âœ… å®Œå…¨åŒ¹é…æ¨¡å¼é‡å»ºæˆåŠŸï¼æ ¼å¼æ‡‰è©²èˆ‡åŸå§‹é é¢å®Œå…¨ä¸€è‡´', 'success');
                        }, 300);
                    };
                    
                    outputFrame.onerror = function(error) {
                        console.error('âŒ å®Œå…¨åŒ¹é…æ¨¡å¼è¼‰å…¥å¤±æ•—:', error);
                        showStatus('âŒ å®Œå…¨åŒ¹é…æ¨¡å¼å¤±æ•—ï¼Œè«‹ç¢ºèªHTMLæ ¼å¼æ­£ç¢º', 'error');
                    };
                    
                    // ç›´æ¥ä½¿ç”¨åŸå§‹HTMLï¼Œä¸åšä»»ä½•åŒ…è£æˆ–ä¿®æ”¹
                    outputFrame.srcdoc = exactHtml;
                }, 100);
                
                // é¡¯ç¤ºè¼¸å‡ºå€åŸŸ
                document.getElementById('outputSection').classList.add('active');
                document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('å®Œå…¨åŒ¹é…æ¨¡å¼å¤±æ•—:', error);
                showStatus('âŒ å®Œå…¨åŒ¹é…æ¨¡å¼å¤±æ•—ï¼Œè«‹ç¢ºèª HTML æ ¼å¼æ­£ç¢º', 'error');
            }
        }
        
        // æª¢æ¸¬å…§å®¹é¡å‹
        function detectContentType(html) {
            if (html.toLowerCase().includes('<!doctype')) {
                return 'å®Œæ•´HTMLæ–‡æª”';
            } else if (html.toLowerCase().includes('<html')) {
                return 'HTMLæ–‡æª”ï¼ˆç„¡DOCTYPEï¼‰';
            } else if (html.includes('<table') || html.includes('<tr')) {
                return 'HTMLè¡¨æ ¼ç‰‡æ®µ';
            } else if (html.includes('<div') || html.includes('<span')) {
                return 'HTMLå€å¡Šç‰‡æ®µ';
            } else {
                return 'ç´”æ–‡å­—æˆ–å…¶ä»–';
            }
        }
        
        // é©—è­‰HTMLæ ¼å¼
        function validateHTML(html) {
            try {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // æª¢æŸ¥è§£æéŒ¯èª¤
                const parserError = doc.querySelector('parsererror');
                if (parserError) {
                    console.warn('âš ï¸ HTMLè§£æè­¦å‘Š:', parserError.textContent);
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('âŒ HTMLé©—è­‰å¤±æ•—:', error);
                return false;
            }
        }
        
        // å„ªåŒ–iframeæ¸²æŸ“ä»¥åŒ¹é…åŸå§‹é é¢
        function optimizeIframeRendering() {
            try {
                const outputFrame = document.getElementById('outputFrame');
                const iframeDoc = outputFrame.contentDocument || outputFrame.contentWindow.document;
                
                if (!iframeDoc) {
                    console.warn('âš ï¸ ç„¡æ³•è¨ªå•iframeæ–‡æª”');
                    return;
                }
                
                // ç¢ºä¿iframeä½¿ç”¨æ¨™æº–æ¨¡å¼æ¸²æŸ“
                if (iframeDoc.compatMode !== 'CSS1Compat') {
                    console.warn('âš ï¸ iframeä¸åœ¨æ¨™æº–æ¨¡å¼ï¼Œå˜—è©¦ä¿®æ­£...');
                }
                
                // ç§»é™¤å¯èƒ½å½±éŸ¿ä½ˆå±€çš„æ¨£å¼
                const body = iframeDoc.body;
                if (body) {
                    // é‡ç½®å¯èƒ½è¢«ç¹¼æ‰¿çš„æ¨£å¼
                    body.style.fontFamily = '';
                    body.style.fontSize = '';
                    body.style.lineHeight = '';
                    
                    // ç¢ºä¿è¡¨æ ¼æ¨£å¼ä¸å—å½±éŸ¿
                    const tables = iframeDoc.querySelectorAll('table');
                    tables.forEach(table => {
                        // ä¿æŒè¡¨æ ¼åŸå§‹çš„border-collapseè¨­å®š
                        const computedStyle = iframeDoc.defaultView.getComputedStyle(table);
                        if (computedStyle.borderCollapse === 'separate') {
                            table.style.borderCollapse = 'separate';
                        }
                    });
                    
                    console.log('âœ… iframeæ¸²æŸ“å„ªåŒ–å®Œæˆ');
                }
                
            } catch (error) {
                console.error('âŒ iframeæ¸²æŸ“å„ªåŒ–å¤±æ•—:', error);
            }
        }
        
        // é©—è­‰iframeå…§å®¹
        function validateIframeContent() {
            try {
                const outputFrame = document.getElementById('outputFrame');
                const iframeDoc = outputFrame.contentDocument || outputFrame.contentWindow.document;
                
                if (!iframeDoc) {
                    console.warn('âš ï¸ ç„¡æ³•è¨ªå•iframeæ–‡æª”');
                    return false;
                }
                
                // æª¢æŸ¥åŸºæœ¬çµæ§‹
                const hasBody = iframeDoc.body !== null;
                const hasTable = iframeDoc.querySelector('table') !== null;
                const hasStyles = iframeDoc.querySelector('style') !== null;
                const rowCount = iframeDoc.querySelectorAll('tr').length;
                
                console.log('ğŸ” iframeå…§å®¹é©—è­‰:');
                console.log('  - æœ‰body:', hasBody);
                console.log('  - æœ‰è¡¨æ ¼:', hasTable);
                console.log('  - æœ‰æ¨£å¼:', hasStyles);
                console.log('  - è¡Œæ•¸:', rowCount);
                
                // æ›´æ–°ç‹€æ…‹è¨Šæ¯
                if (hasTable && rowCount > 0) {
                    showStatus(`âœ… é é¢é‡å»ºæˆåŠŸï¼åµæ¸¬åˆ° ${rowCount} è¡Œå…§å®¹`, 'success');
                } else if (hasBody) {
                    showStatus('âœ… é é¢é‡å»ºæˆåŠŸï¼æ ¼å¼å·²ä¿æŒ', 'success');
                } else {
                    showStatus('âš ï¸ é é¢é‡å»ºå®Œæˆï¼Œä½†å¯èƒ½ç¼ºå°‘éƒ¨åˆ†å…§å®¹', 'info');
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error('âŒ iframeå…§å®¹é©—è­‰å¤±æ•—:', error);
                return false;
            }
        }
        
        // æ³¨å…¥è…³æœ¬åˆ°iframe
        function injectScriptToIframe() {
            try {
                const outputFrame = document.getElementById('outputFrame');
                const iframeDoc = outputFrame.contentDocument || outputFrame.contentWindow.document;
                
                // å‰µå»ºè…³æœ¬å…ƒç´ 
                const script = iframeDoc.createElement('script');
                
                // ç›´æ¥åµŒå…¥è²¨è»Šä½ç½®æŸ¥è©¢çš„æ ¸å¿ƒé‚è¼¯
                script.textContent = `
                    // ç°¡åŒ–ç‰ˆçš„è²¨è»Šä½ç½®æŸ¥è©¢é‚è¼¯
                    class SimpleTruckLocator {
                        constructor() {
                            this.shopeeData = [];
                            this.isLoaded = false;
                            this.GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwFSPXkgQRDm4nUk4ctqrzKBjqeasJ0uSRpBYDNoqX4OlI_PLtiznjomf6viXkrPF4w/exec';
                            this.SHEET_ID = '1xja90NLxCTbQgxUSdx4nI0-BJXMLr0DHhu7Xln612vI';
                        }

                        async fetchRequest(url, params = {}) {
                            try {
                                const urlParams = new URLSearchParams(params);
                                const response = await fetch(url + '?' + urlParams.toString(), {
                                    method: 'GET',
                                    mode: 'cors'
                                });
                                
                                if (!response.ok) {
                                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                                }
                                
                                const data = await response.json();
                                return data;
                            } catch (error) {
                                throw new Error('ç¶²è·¯è«‹æ±‚å¤±æ•—: ' + error.message);
                            }
                        }

                        async loadShopeeData() {
                            try {
                                console.log('ğŸ”„ è¼‰å…¥è¦çš®è³‡æ–™ä¸­...');
                                
                                const result = await this.fetchRequest(this.GAS_WEB_APP_URL, {
                                    action: 'read',
                                    sheetId: this.SHEET_ID
                                });
                                
                                if (result && result.success && result.data && result.data.length > 1) {
                                    this.shopeeData = result.data.slice(1);
                                    this.isLoaded = true;
                                    console.log('âœ… æˆåŠŸè¼‰å…¥è¦çš®è³‡æ–™:', this.shopeeData.length, 'ç­†');
                                    return true;
                                } else {
                                    throw new Error(result?.error || 'ç„¡æ³•å–å¾—è³‡æ–™');
                                }
                            } catch (error) {
                                console.error('âŒ è¼‰å…¥è¦çš®è³‡æ–™å¤±æ•—:', error);
                                return false;
                            }
                        }

                        findProductRows() {
                            const possibleSelectors = ['tr.lh-2', 'tr', 'tbody tr', '.table tr'];
                            let foundRows = [];
                            
                            for (const selector of possibleSelectors) {
                                const elements = document.querySelectorAll(selector);
                                if (elements.length > 0) {
                                    foundRows = Array.from(elements);
                                    break;
                                }
                            }
                            
                            const rows = [];
                            foundRows.forEach(row => {
                                const cells = row.querySelectorAll('td, div, span');
                                if (cells.length >= 3) {
                                    const texts = Array.from(cells).slice(0, 5).map(cell => cell.textContent?.trim() || '');
                                    const firstCellText = texts[0];
                                    if (firstCellText && 
                                        !firstCellText.includes('å•†å“åç¨±') && 
                                        !firstCellText.includes('é¸é …åç¨±') &&
                                        firstCellText.length > 3) {
                                        rows.push(row);
                                    }
                                }
                            });
                            
                            return rows;
                        }

                        extractProductInfo(row) {
                            const cells = row.querySelectorAll('td, div, span');
                            if (cells.length < 3) return null;
                            
                            let productName = cells[0]?.textContent?.trim() || '';
                            let optionName = cells[1]?.textContent?.trim() || '';
                            
                            productName = productName.replace(/\\s+/g, ' ').trim();
                            optionName = optionName.replace(/\\s+/g, ' ').trim();
                            optionName = optionName.replace(/^'="|"$/g, '').trim();
                            
                            if (!productName || productName.length < 5) return null;
                            
                            return {
                                productName: productName,
                                optionName: optionName || '',
                                row: row
                            };
                        }

                        findTruckLocation(productName, optionName) {
                            const match = this.shopeeData.find(row => {
                                const shoppeeProductName = (row[1] || '').trim();
                                const shoppeeOptionName = (row[3] || '').trim();
                                
                                const productMatch = shoppeeProductName === productName;
                                
                                let optionMatch = false;
                                if (!optionName && !shoppeeOptionName) {
                                    optionMatch = true;
                                } else if (optionName && shoppeeOptionName) {
                                    optionMatch = shoppeeOptionName === optionName;
                                }
                                
                                return productMatch && optionMatch;
                            });
                            
                            if (match) {
                                const truckLocation = match[11] || '';
                                return truckLocation;
                            }
                            
                            return null;
                        }

                        injectTruckLocation(row, truckLocation, optionName) {
                            const cells = row.querySelectorAll('td, div, span');
                            if (cells.length < 2) return;
                            
                            const optionCell = cells[1];
                            if (!optionCell) return;
                            
                            if (optionCell.querySelector('.truck-location-badge')) {
                                return;
                            }
                            
                            const truckBadge = document.createElement('div');
                            truckBadge.className = 'truck-location-badge';
                            truckBadge.innerHTML = '<span class="truck-icon">ğŸšš</span> ' + truckLocation;
                            truckBadge.style.cssText = 
                                'display: inline-block;' +
                                'background: #48bb78;' +
                                'color: white;' +
                                'padding: 2px 6px;' +
                                'border-radius: 4px;' +
                                'font-size: 12px;' +
                                'margin-left: 8px;' +
                                'font-weight: bold;';
                            
                            optionCell.appendChild(truckBadge);
                            row.style.backgroundColor = '#e8f5e9';
                            row.classList.add('truck-location-found');
                            
                            console.log('âœ… å·²æ¨™è¨˜: ' + truckLocation + ' (' + optionName + ')');
                        }

                        async processProductsOnPage() {
                            if (!this.isLoaded) {
                                await this.loadShopeeData();
                            }

                            const productRows = this.findProductRows();
                            let processedCount = 0;
                            let foundCount = 0;
                            
                            productRows.forEach(row => {
                                const productInfo = this.extractProductInfo(row);
                                if (productInfo) {
                                    processedCount++;
                                    const truckLocation = this.findTruckLocation(productInfo.productName, productInfo.optionName);
                                    
                                    if (truckLocation) {
                                        foundCount++;
                                        this.injectTruckLocation(row, truckLocation, productInfo.optionName);
                                    }
                                }
                            });
                            
                            console.log('âœ… è™•ç†å®Œæˆ: ' + processedCount + ' å€‹å•†å“ï¼Œæ‰¾åˆ° ' + foundCount + ' å€‹ä½ç½®');
                            
                            // é€šçŸ¥çˆ¶é é¢æƒæå®Œæˆ
                            window.parent.postMessage({
                                type: 'scanComplete',
                                data: { total: processedCount, found: foundCount }
                            }, '*');
                        }
                    }

                    // å…¨åŸŸè®Šæ•¸
                    window.truckLocator = new SimpleTruckLocator();
                    
                    // ç›£è½æƒæè«‹æ±‚
                    window.addEventListener('message', (event) => {
                        if (event.data.type === 'startScan') {
                            window.truckLocator.processProductsOnPage();
                        }
                    });
                    
                    console.log('ğŸšš iframe ä¸­çš„è²¨è»Šä½ç½®æŸ¥è©¢å·²å°±ç·’');
                `;
                
                // å°‡è…³æœ¬åŠ åˆ°iframeçš„headä¸­
                iframeDoc.head.appendChild(script);
                
                console.log('âœ… è…³æœ¬å·²æ³¨å…¥åˆ°iframe');
                
            } catch (error) {
                console.error('æ³¨å…¥è…³æœ¬å¤±æ•—:', error);
            }
        }
        
        // æƒæé é¢
        function scanPage() {
            const outputFrame = document.getElementById('outputFrame');
            
            if (!outputFrame.srcdoc && !outputFrame.src) {
                showStatus('è«‹å…ˆé‡å»ºé é¢', 'error');
                return;
            }
            
            showStatus('ğŸ” æ­£åœ¨æƒæè²¨è»Šä½ç½®...', 'info');
            
            try {
                // ç™¼é€è¨Šæ¯çµ¦iframeä¸­çš„è…³æœ¬
                outputFrame.contentWindow.postMessage({
                    type: 'startScan'
                }, '*');
                
            } catch (error) {
                console.error('æƒæå¤±æ•—:', error);
                showStatus('âŒ æƒæå¤±æ•—ï¼Œè«‹é‡æ–°è¼‰å…¥é é¢', 'error');
            }
        }
        
        // ç›£è½ä¾†è‡ªiframeçš„è¨Šæ¯
        window.addEventListener('message', (event) => {
            if (event.data.type === 'scanComplete') {
                const { total, found } = event.data.data;
                if (found > 0) {
                    showStatus(`âœ… æƒæå®Œæˆï¼è™•ç† ${total} å€‹å•†å“ï¼Œæ‰¾åˆ° ${found} å€‹è²¨è»Šä½ç½®`, 'success');
                } else {
                    showStatus(`âš ï¸ æƒæå®Œæˆï¼Œè™•ç† ${total} å€‹å•†å“ï¼Œä½†æœªæ‰¾åˆ°åŒ¹é…çš„è²¨è»Šä½ç½®`, 'info');
                }
            }
        });
        
        // æ¸…é™¤æ‰€æœ‰å…§å®¹
        function clearAll() {
            document.getElementById('htmlInput').value = '';
            document.getElementById('outputFrame').innerHTML = '';
            document.getElementById('outputSection').classList.remove('active');
            showStatus('å·²æ¸…é™¤æ‰€æœ‰å…§å®¹', 'info');
        }
        
        // ç›£è½éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + Enter é‡å»ºé é¢
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                recreatePage();
            }
            // Ctrl/Cmd + S æƒæé é¢
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                scanPage();
            }
        });
        
        // é é¢è¼‰å…¥æ™‚çš„æç¤º
        window.addEventListener('load', () => {
            console.log('ğŸšš è¦çš®è²¨è»Šä½ç½®æŸ¥è©¢ - é‡å»ºåˆ—å°é é¢å·²å°±ç·’');
        });
    </script>
</body>
</html>